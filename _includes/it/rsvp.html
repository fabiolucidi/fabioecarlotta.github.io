<section id="rsvp" class="section-std">

    <div class="default-title">
        <h2>RSVP</h2>
    </div>

    <p class="default-text">Per aiutarci a organizzare tutto al meglio, vi chiediamo di rispondere ad alcune domande.</p>
    <p class="default-text">Allergie, arrivi, navette, canzoniâ€¦ poche domande, tutte utili.</p>
    <p class="default-text">Vi chiediamo di rispondere <strong>entro il 20 febbraio 2026</strong>.</p>
    <p class="default-text">Grazie mille â¤ï¸</p>

    <div class="form-container">

    <form id="rsvp-form">

        <!-- STEP 1 -->
        <div class="step active" id="step-1">
            <h3 class="step-title">General Information</h3>

            <div class="floating-label">
                <input type="text" id="nome" name="nome" required placeholder=" " />
                <label>Name*</label>
            </div>

            <div class="floating-label">
                <input type="text" id="cognome" name="cognome" required placeholder=" " />
                <label>Surname*</label>
            </div>

            <div class="phone-row">
                <div class="floating-label">
                    <select id="prefix" name="prefix" required>
                        <option value="" disabled selected hidden></option>

                        <!-- PRIORITARI -->
                        <option value="+39">ğŸ‡®ğŸ‡¹ Italy (+39)</option>
                        <option value="+44">ğŸ‡¬ğŸ‡§ United Kingdom (+44)</option>
                        <option value="+34">ğŸ‡ªğŸ‡¸ Spain (+34)</option>
                        <option value="+43">ğŸ‡¦ğŸ‡¹ Austria (+43)</option>
                        <option value="+1">ğŸ‡ºğŸ‡¸ United States (+1)</option>

                        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>

                        <!-- RESTO DEL MONDO (lista ottimizzata) -->
                        <option value="+33">ğŸ‡«ğŸ‡· France (+33)</option>
                        <option value="+49">ğŸ‡©ğŸ‡ª Germany (+49)</option>
                        <option value="+41">ğŸ‡¨ğŸ‡­ Switzerland (+41)</option>
                        <option value="+31">ğŸ‡³ğŸ‡± Netherlands (+31)</option>
                        <option value="+32">ğŸ‡§ğŸ‡ª Belgium (+32)</option>
                        <option value="+351">ğŸ‡µğŸ‡¹ Portugal (+351)</option>
                        <option value="+30">ğŸ‡¬ğŸ‡· Greece (+30)</option>
                        <option value="+45">ğŸ‡©ğŸ‡° Denmark (+45)</option>
                        <option value="+46">ğŸ‡¸ğŸ‡ª Sweden (+46)</option>
                        <option value="+47">ğŸ‡³ğŸ‡´ Norway (+47)</option>
                        <option value="+48">ğŸ‡µğŸ‡± Poland (+48)</option>
                        <option value="+420">ğŸ‡¨ğŸ‡¿ Czech Republic (+420)</option>
                        <option value="+421">ğŸ‡¸ğŸ‡° Slovakia (+421)</option>
                        <option value="+36">ğŸ‡­ğŸ‡º Hungary (+36)</option>
                        <option value="+40">ğŸ‡·ğŸ‡´ Romania (+40)</option>
                        <option value="+353">ğŸ‡®ğŸ‡ª Ireland (+353)</option>
                        <option value="+972">ğŸ‡®ğŸ‡± Israel (+972)</option>
                        <option value="+90">ğŸ‡¹ğŸ‡· Turkey (+90)</option>
                        <option value="+7">ğŸ‡·ğŸ‡º Russia (+7)</option>
                        <option value="+86">ğŸ‡¨ğŸ‡³ China (+86)</option>
                        <option value="+81">ğŸ‡¯ğŸ‡µ Japan (+81)</option>
                        <option value="+82">ğŸ‡°ğŸ‡· South Korea (+82)</option>
                        <option value="+61">ğŸ‡¦ğŸ‡º Australia (+61)</option>
                        <option value="+64">ğŸ‡³ğŸ‡¿ New Zealand (+64)</option>
                        <option value="+91">ğŸ‡®ğŸ‡³ India (+91)</option>
                        <option value="+52">ğŸ‡²ğŸ‡½ Mexico (+52)</option>
                        <option value="+54">ğŸ‡¦ğŸ‡· Argentina (+54)</option>
                        <option value="+55">ğŸ‡§ğŸ‡· Brazil (+55)</option>
                        <option value="+56">ğŸ‡¨ğŸ‡± Chile (+56)</option>
                        <option value="+57">ğŸ‡¨ğŸ‡´ Colombia (+57)</option>
                    </select>
                    <label>Prefix*</label>
                </div>


                <div class="floating-label">
                    <input type="text" id="telefono" name="telefono" required placeholder=" " pattern="[0-9+() ]+" />
                    <label>Phone number*</label>
                </div>
            </div>

            <div class="floating-label">
                <input type="email" id="email" name="email" placeholder=" " />
                <label>Email</label>
            </div>

            <button type="button" class="next-btn">Next</button>
        </div>

        <!-- NEW STEP 2 â€” WILL YOU JOIN US? -->
        <div class="step" id="step-2">
            <h3 class="step-title">Wedding attendance</h3>

            <div class="floating-label">
                <select id="join" name="join" required>
                    <option value="" disabled selected hidden></option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
                <label>Will you join us for our wedding?</label>
            </div>

            <button type="button" class="back-btn">Back</button>
            <button type="button" class="next-btn">Next</button>
        </div>


        <!-- STEP 3 -->
        <div class="step" id="step-3">
            <h3 class="step-title">Travel information</h3>

            <div class="floating-label">
                <select id="arrivo" name="arrivo" required>
                    <option value="" disabled selected hidden></option>
                    <option value="19/06">19/06</option>
                    <option value="20/06">20/06</option>
                    <option value="I live in Verona">I live in Verona</option>
                </select>
                <label>When will you arrive?</label>
            </div>

            <div class="floating-label">
                <select id="shuttle" name="shuttle" required>
                    <option value="" disabled selected hidden></option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
                <label>Will you use the shuttle?</label>
            </div>

            <button type="button" class="back-btn">Back</button>
            <button type="button" class="next-btn">Next</button>
        </div>

        <!-- STEP 4 -->
        <div class="step" id="step-4">
            <h3 class="step-title">Food information</h3>

            <div class="floating-label">
                <select id="allergie" name="allergie" required>
                    <option value="" disabled selected hidden></option>
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                </select>
                <label>Do you have any allergies?</label>
            </div>

            <div class="floating-label" id="allergieField" style="display:none;">
                <textarea id="listaAllergie" name="listaAllergie" placeholder=" "></textarea>
                <label>If yes, specify</label>
            </div>

            <div class="floating-label">
                <select id="dieta" name="dieta" required>
                    <option value="" disabled selected hidden></option>
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                </select>
                <label>Diet restrictions?</label>
            </div>

            <div class="floating-label" id="dietaField" style="display:none;">
                <select id="tipoDieta" name="tipoDieta">
                    <option value="" disabled selected hidden></option>
                    <option value="Vegetarian">Vegetarian</option>
                    <option value="Vegan">Vegan</option>
                </select>
                <label>If yes, choose</label>
            </div>

            <button type="button" class="back-btn">Back</button>
            <button type="button" class="next-btn">Next</button>
        </div>

        <!-- STEP 5 -->
        <div class="step" id="step-5">
            <h3 class="step-title">Others</h3>

            <div class="floating-label">
                <textarea id="messaggio" name="messaggio" maxlength="500" placeholder=" "></textarea>
                <label>Anything else? ğŸ˜Š</label>
            </div>

            <p id="char-count">0/500</p>

            <button type="button" class="back-btn">Back</button>
            <button type="submit" class="submit-btn">Send RSVP</button>
        </div>

    </form>

    <div id="thankyou-animation"></div>
</div>

<!-- reCAPTCHA -->
<script src="https://www.google.com/recaptcha/api.js?render=6LfSNhosAAAAAAGFpMX5do3nDtl8ImAYIgpHLV8k"></script>

<!-- Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
    /* ======================
       CONFIG
    ====================== */
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbw9rTu1poEXSBb_q1OTctQ5K4YTrWmsDW4md4xYdJI2mYXEyVxcU2Mk-feFtztP2fln/exec";
    const SITE_KEY = "6LfSNhosAAAAAAGFpMX5do3nDtl8ImAYIgpHLV8k";

    /* ======================
       MULTISTEP LOGIC
    ====================== */
    let currentStep = 1;
    const steps = document.querySelectorAll(".step");

    function showStep(n) {
        steps.forEach(s => s.classList.remove("active"));
        const next = document.getElementById("step-" + n);
        if (next) {
            next.classList.add("active");
            currentStep = n;
        }
    }

    document.addEventListener("DOMContentLoaded", () => showStep(1));

    /* BOTTONI "NEXT" */
    document.querySelectorAll(".next-btn").forEach(btn =>
        btn.addEventListener("click", () => {

            // STEP 2 â€” Wedding Attendance
            if (currentStep === 2) {
                const join = document.getElementById("join").value;

                // If NO â†’ immediate send
                if (join === "No") {
                    submitRSVP(false);  // NO CONFETTI
                    return;
                }
            }

            showStep(currentStep + 1);
        })
    );

    /* BOTTONI "BACK" */
    document.querySelectorAll(".back-btn").forEach(btn =>
        btn.addEventListener("click", () => showStep(currentStep - 1))
    );

    /* TOGGLE ALLERGIE / DIETA */
    document.getElementById("allergie").addEventListener("change", e => {
        document.getElementById("allergieField").style.display =
            e.target.value === "Yes" ? "block" : "none";
    });

    document.getElementById("dieta").addEventListener("change", e => {
        document.getElementById("dietaField").style.display =
            e.target.value === "Yes" ? "block" : "none";
    });

    /* CONTATORE CARATTERI */
    document.getElementById("messaggio").addEventListener("input", function () {
        document.getElementById("char-count").textContent = this.value.length + "/500";
    });


    /* ======================
       SUBMIT HANDLER
    ====================== */
    document.getElementById("rsvp-form").addEventListener("submit", function (e) {
        e.preventDefault();
        submitRSVP(true);  // normal submit = YES confetti
    });


    /* ======================
       UNIFIED SUBMIT FUNCTION
    ====================== */
    async function submitRSVP(playConfetti = true) {

        const token = await grecaptcha.execute(SITE_KEY, { action: "submit" });

        const params = new URLSearchParams();

        // TUTTI I CAMPI (incluso join!)
        const fields = [
            "nome","cognome",
            "prefix","telefono","email",
            "join",
            "arrivo","shuttle",
            "allergie","listaAllergie",
            "dieta","tipoDieta",
            "messaggio"
        ];

        fields.forEach(f =>
            params.append(f, document.getElementById(f)?.value || "")
        );

        params.append("token", token);

        try {
            const res = await fetch(ENDPOINT, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: params.toString()
            });

            const json = await res.json();

            if (json.status === "success") {
                if (playConfetti) launchConfetti();

                showStep(1);
                document.getElementById("rsvp-form").reset();
                alert("Grazie! La tua risposta Ã¨ stata registrata.");
            } else {
                alert("Errore: " + JSON.stringify(json));
            }

        } catch (err) {
            console.error(err);
            alert("Errore di connessione.");
        }
    }


    /* ======================
       CONFETTI
    ====================== */
    function launchConfetti() {
        var duration = 1500;
        var end = Date.now() + duration;

        (function frame() {
            confetti({ particleCount: 6, spread: 70 });
            if (Date.now() < end) requestAnimationFrame(frame);
        })();
    }
</script>

</section>
